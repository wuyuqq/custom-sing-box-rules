name: Build domains and ruleset

on:
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * *"
  push:
    branches:
      - master
    paths-ignore:
      - "**/README.md"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ 设置变量
      - name: Set variables
        run: |
          echo "update_version=$(date -d '+8 hours' +%Y-%m-%d)" >> $GITHUB_ENV

          declare -A urls=(
            [LocalAreaNetwork]=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/LocalAreaNetwork.list
            [private_direct]=https://raw.githubusercontent.com/wuyuqq/247cp/master/sing-box/ruleset/private_cn.list
            [private_proxy]=https://raw.githubusercontent.com/wuyuqq/247cp/master/sing-box/ruleset/private_!cn.list
            [Emby]=https://raw.githubusercontent.com/wuyuqq/247cp/master/sing-box/ruleset/emby.list
            [GoogleCN]=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/GoogleCN.list
            [GoogleFCM]=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/GoogleFCM.list
            [Bing]=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Bing.list
            [OneDrive]=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/OneDrive.list
            [Microsoft]=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Microsoft.list
            [Apple]=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Apple.list
            [Telegram]=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Telegram.list
            [OpenAi]=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/OpenAi.list
            [YouTube]=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/YouTube.list
            [ProxyMedia]=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/ProxyMedia.list
            [ProxyGFWlist]=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/ProxyGFWlist.list
            [ChinaDomain]=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/ChinaDomain.list
            [ChinaCompanyIp]=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/ChinaCompanyIp.list
            [Spotify]=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/Spotify.list
            [TikTok]=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/TikTok.list
            [Speedtest]=https://raw.githubusercontent.com/dler-io/Rules/master/Surge/Surge%203/Provider/Speedtest.list
          )

          for k in "${!urls[@]}"; do
            echo "$k=${urls[$k]}" >> $GITHUB_ENV
          done
        shell: bash

      # 2️⃣ 检出仓库
      - name: Checkout repository
        uses: actions/checkout@v3

      # 3️⃣ 下载 domain lists 并生成规则目录
      - name: Download domain lists
        run: |
          mkdir -p ./domains/ ./tools/rules/
          lists=(LocalAreaNetwork private_direct private_proxy Emby GoogleCN GoogleFCM Bing OneDrive Microsoft Apple Telegram OpenAi YouTube ProxyMedia ProxyGFWlist ChinaDomain ChinaCompanyIp Spotify TikTok Speedtest)
          for l in "${lists[@]}"; do
            url_var=$(eval echo \$$l)
            if [ "$l" == "ChinaCompanyIp" ]; then
              grep_pattern='^(IP-CIDR|IP-CIDR6)'
            else
              grep_pattern='^(DOMAIN|DOMAIN-SUFFIX|DOMAIN-KEYWORD|IP-CIDR|IP-CIDR6)'
            fi
            curl -sSL "$url_var" | grep -E "$grep_pattern" > ./domains/$l.list

            # 准备 convert.sh 需要的规则目录
            mkdir -p "./tools/rules/$l/"
            cp "./domains/$l.list" "./tools/rules/$l/$l.yaml"
          done

      # 4️⃣ 下载 sing-box 核心并运行 convert.sh
      - name: Setup sing-box and convert rules
        run: |
          mkdir -p ./tools/
          wget -qO- https://github.com/SagerNet/sing-box/releases/download/v1.10.1/sing-box-1.10.1-linux-amd64.tar.gz | tar -zxf - -C ./tools/
          mv -f ./tools/sing-box-1.10.1-linux-amd64/sing-box ./tools/
          cd ./tools/
          chmod +x convert.sh && ./convert.sh
          mkdir -p ../sing-box-ruleset/
          cp -f ./*.json ./*.srs ../sing-box-ruleset/

      # 5️⃣ 提交到 sing-box-ruleset 分支
      - name: Commit and push ruleset
        run: |
          cd ./sing-box-ruleset/ || exit 1
          git init
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git checkout -b sing-box-ruleset
          git add . && git commit -m "规则集更新于 ${update_version}"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f -u origin sing-box-ruleset
